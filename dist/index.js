"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.assetsAgent=exports.AssetsAgent=void 0;var mapNameAssetTypes={},isChildClassOf=(isChildClassOf=cc.js.isChildClassOf)||cc.isChildClassOf,DELAY_FREE_DEFAULT=60,AssetsAgent=function(){function e(e){void 0===e&&(e=DELAY_FREE_DEFAULT),this._mapTypeInfos=new Map,this._mapNameTypeInfos={},this._mapUses={},this._loadingCount=0,this._waitFrees={},this._isDestroyed=!1,this._time=0,this._intervalIndex=0,this._delayFree=0,this._delayFree=e,this._intervalIndex=setInterval(this._update.bind(this),1e3);var e=[{name:"text",type:cc.TextAsset},{name:"buffer",type:cc.BufferAsset},{name:"texture_2d",type:cc.Texture2D},{name:"sprite_frame",type:cc.SpriteFrame},{name:"mesh",type:cc.Mesh},{name:"effect",type:cc.EffectAsset},{name:"material",type:cc.Material},{name:"physics_material",type:cc.PhysicsMaterial},{name:"animation_clip",type:cc.AnimationClip},{name:"audio_clip",type:cc.AudioClip},{name:"prefab",type:cc.Prefab},{name:"scene",type:cc.SceneAsset},{name:"font",type:cc.Font},{name:"bitmap_font",type:cc.BitmapFont},{name:"json",type:cc.JsonAsset},{name:"particle_asset",type:cc.ParticleAsset},{name:"tiled_map_asset",type:cc.TiledMapAsset}],t=this._mapTypeInfos,s=this._mapNameTypeInfos;e.forEach(function(e){t.set(e.type,e),s[e.name]=e})}return e.prototype.del=function(){this._isDestroyed=!0,clearInterval(this._intervalIndex),this._intervalIndex=0,this._clear()},e.prototype.init=function(e){this._delayFree=e=void 0===e?DELAY_FREE_DEFAULT:e,this._clear()},e.prototype.registerTypeInfo=function(e,t){if(this._mapTypeInfos.get(t))throw new Error("The type has been registered!");if(this._mapNameTypeInfos[e])throw new Error("The type name ("+e+") has been registered !");var s={name:e,type:t};this._mapTypeInfos.set(t,s),this._mapNameTypeInfos[e]=s},e.prototype.getUseInfo=function(e){return this._mapUses[e]},e.prototype.use=function(){var s,n,e,t,a=this;this._isDestroyed||(++this._loadingCount,s=this._makeArgsUse.apply(this,arguments),n=this._mapUses,e=function(e,t){a._isDestroyed||(--a._loadingCount,e?s.onCompleted&&s.onCompleted(e):((e=n[s.keyUse])||(n[s.keyUse]=e={}),mapNameAssetTypes[s.type.name]||(mapNameAssetTypes[s.type.name]=s.type),e[s.bundle.name+" "+s.type.name+" "+s.path]||(t.addRef(),e[s.bundle.name+" "+s.type.name+" "+s.path]=!0),s.onCompleted&&s.onCompleted(null,t)))},this._removeWaitFree(s),(t=s.bundle.get(s.path,s.type.type))?e(null,t):s.bundle.load(s.path,s.type.type,s.onProgess,e))},e.prototype.free=function(){if(!this._isDestroyed){var e=this._makeArgsFree.apply(this,arguments);if(1<arguments.length)this._addWaitFree(e);else{var t=this._mapUses[e.keyUse];if(t)for(var s in t){s=s.split(" ");this._addWaitFree({keyUse:e.keyUse,bundle:cc.assetManager.getBundle(s[0]),type:mapNameAssetTypes[s[1]],path:s[2]})}}}},e.prototype._checkAndDoWaitFrees=function(){var e,t=this,s=this._waitFrees,n=this._time,a=[];for(e in s){var i=e.split(" ");s[e]<=n&&a.push({keyUse:i[0],bundle:cc.assetManager.getBundle(i[1]),type:mapNameAssetTypes[i[2]],path:i[3]})}a.forEach(function(e){delete s[e.keyUse+" "+e.bundle.name+" "+e.type.name+" "+e.path],t._doFree(e.keyUse,e.path,e.type,e.bundle)})},e.prototype._doFree=function(e,t,s,n){var a=this._mapUses,i=a[e];delete i[n.name+" "+s.name+" "+t],n.get(t,s.type).decRef(),Object.keys(i).length||delete a[e]},e.prototype._addWaitFree=function(e){this._waitFrees[e.keyUse+" "+e.bundle.name+" "+e.type.name+" "+e.path]=this._time+this._delayFree},e.prototype._removeWaitFree=function(e){delete this._waitFrees[e.keyUse+" "+e.bundle.name+" "+e.type.name+" "+e.path]},e.prototype._update=function(){++this._time,this._loadingCount<=0&&this._checkAndDoWaitFrees()},e.prototype._clear=function(){this._loadingCount=0;var e,t=this._mapUses;for(e in t){var s=t[e];if(s)for(var n in s){n=n.split(" ");cc.assetManager.getBundle(n[0]).get(n[2],mapNameAssetTypes[n[1]].type).decRef()}}this._mapUses={},this._waitFrees={},this._time=0},e.prototype._makeArgsUse=function(){if(arguments.length<3||"string"!=typeof arguments[0]||"string"!=typeof arguments[1])throw new Error("Arguments is invalid !");var e=this._mapTypeInfos.get(arguments[2]);if(!e)throw new Error("Invalid cc asset type!");for(var t={keyUse:arguments[0].trim(),path:arguments[1].trim(),type:e,bundle:cc.resources},s=3;s<arguments.length;++s)3==s&&"function"!=typeof arguments[s]?t.bundle=arguments[s]||cc.resources:"function"==typeof arguments[s]&&(s+1<arguments.length&&"function"==typeof arguments[s+1]?t.onProgess=arguments[s]:t.onCompleted=arguments[s]);return t},e.prototype._makeArgsFree=function(){if(arguments.length<1||"string"!=typeof arguments[0])throw new Error("Arguments is invalid !");var e;if(arguments[2]&&!(e=this._mapTypeInfos.get(arguments[2])))throw new Error("Invalid cc asset type!");return{keyUse:arguments[0].trim(),path:"string"==typeof arguments[1]?arguments[1].trim():arguments[1],type:e,bundle:arguments[3]||cc.resources}},e}();exports.AssetsAgent=AssetsAgent,exports.assetsAgent=new AssetsAgent,window&&(window.assetsAgent=exports.assetsAgent);