"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.assetAgent=exports.AssetAgent=void 0;var mapMK=require("./map-mk"),isChildClassOf=(isChildClassOf=cc.js.isChildClassOf)||cc.isChildClassOf,DELAY_FREE_DEFAULT=60;function findIndex(e,t){for(var s=e.length,i=0;i<s;++i)if(t(e[i]))return i;return-1}var AssetAgent=function(){function e(e){void 0===e&&(e=DELAY_FREE_DEFAULT),this._mapUses={},this._loadingCount=0,this._waitFrees=mapMK.createMapMultiKeys(4),this._isDestroyed=!1,this._time=0,this._intervalIndex=0,this._delayFree=0,this._delayFree=e,this._intervalIndex=setInterval(this._update.bind(this),1e3)}return e.prototype.del=function(){this._isDestroyed=!0,clearInterval(this._intervalIndex),this._intervalIndex=0,this._clear()},e.prototype.init=function(e){void 0===e&&(e=DELAY_FREE_DEFAULT),this._delayFree=e,this._clear()},e.prototype.getUseInfo=function(e){return this._mapUses[e]},e.prototype.use=function(){var s,i,e,t,n=this;this._isDestroyed||(++this._loadingCount,s=this._makeArgsUse.apply(this,arguments),i=this._mapUses,e=function(e,t){n._isDestroyed||(--n._loadingCount,e?s.onCompleted&&s.onCompleted(e):((e=i[s.keyUse])||(i[s.keyUse]=e=mapMK.createMapMultiKeys(3)),e.get([s.bundle,s.type,s.path])||(t.addRef(),e.set([s.bundle,s.type,s.path],!0)),s.onCompleted&&s.onCompleted(null,t)))},this._removeWaitFree(s),(t=cc.resources.get(s.path,s.type))?e(null,t):cc.resources.load(s.path,s.type,s.onProgess,e))},e.prototype.free=function(){var s,e,i=this;this._isDestroyed||(s=this._makeArgsFree.apply(this,arguments),1<arguments.length?this._addWaitFree(s):(e=this._mapUses[s.keyUse])&&e.forEach(function(e,t){i._addWaitFree({keyUse:s.keyUse,bundle:t[0],type:t[1],path:t[2]})}))},e.prototype._checkAndDoWaitFrees=function(){var t=this,e=this._waitFrees,s=this._time,i=[];e.forEach(function(e,t){e<=s&&i.push({keyUse:t[0],bundle:t[1],type:t[2],path:t[3]})}),i.forEach(function(e){t._doFree(e.keyUse,e.path,e.type,e.bundle)})},e.prototype._doFree=function(e,t,s,i){this._mapUses[e].delete([i,s,t]),i.get(t,s).decRef()},e.prototype._addWaitFree=function(e){this._waitFrees.set([e.keyUse,e.bundle,e.type,e.path],this._time+this._delayFree)},e.prototype._removeWaitFree=function(e){this._waitFrees.delete([e.keyUse,e.bundle,e.type,e.path])},e.prototype._update=function(){++this._time,this._loadingCount<=0&&this._checkAndDoWaitFrees()},e.prototype._clear=function(){this._loadingCount=0;var e,t=this._mapUses;for(e in t){var s=t[e];s&&s.forEach(function(e,t){t[0].get(t[2],t[1]).decRef()})}this._mapUses={},this._waitFrees.clear(),this._time=0},e.prototype._makeArgsUse=function(){if(arguments.length<3||"string"!=typeof arguments[0]||"string"!=typeof arguments[1])throw new Error("Arguments is invalid !");for(var e={keyUse:arguments[0],path:arguments[1],type:arguments[2],bundle:arguments[3]||cc.resources},t=2;t<arguments.length;++t)2==t&&isChildClassOf(arguments[t],cc.Asset)?e.type=arguments[t]:3==t&&isChildClassOf(arguments[t],cc.AssetManager.Bundle)?e.bundle=arguments[t]:"function"==typeof arguments[t]&&(t+1<arguments.length&&"function"==typeof arguments[t+1]?e.onProgess=arguments[t]:e.onCompleted=arguments[t]);return e},e.prototype._makeArgsFree=function(){if(arguments.length<1||"string"!=typeof arguments[0])throw new Error("Arguments is invalid !");return{keyUse:arguments[0],path:arguments[1],type:arguments[2],bundle:arguments[3]||cc.resources}},e}();exports.AssetAgent=AssetAgent,exports.assetAgent=new AssetAgent,window&&(window.assetAgent=exports.assetAgent);