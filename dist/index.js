"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.assetsAgent=exports.AssetsAgent=void 0;var mapNameAssetTypes={},isChildClassOf=(isChildClassOf=cc.js.isChildClassOf)||cc.isChildClassOf,DELAY_FREE_DEFAULT=60,AssetsAgent=function(){function e(e){void 0===e&&(e=DELAY_FREE_DEFAULT),this._mapUses={},this._loadingCount=0,this._waitFrees={},this._isDestroyed=!1,this._time=0,this._intervalIndex=0,this._delayFree=0,this._delayFree=e,this._intervalIndex=setInterval(this._update.bind(this),1e3)}return e.prototype.del=function(){this._isDestroyed=!0,clearInterval(this._intervalIndex),this._intervalIndex=0,this._clear()},e.prototype.init=function(e){this._delayFree=e=void 0===e?DELAY_FREE_DEFAULT:e,this._clear()},e.prototype.getUseInfo=function(e){return this._mapUses[e]},e.prototype.use=function(){var s,n,e,t,i=this;this._isDestroyed||(++this._loadingCount,s=this._makeArgsUse.apply(this,arguments),n=this._mapUses,e=function(e,t){i._isDestroyed||(--i._loadingCount,e?s.onCompleted&&s.onCompleted(e):((e=n[s.keyUse])||(n[s.keyUse]=e={}),mapNameAssetTypes[s.type.name]||(mapNameAssetTypes[s.type.name]=s.type),e[s.bundle.name+" "+s.type.name+" "+s.path]||(t.addRef(),e[s.bundle.name+" "+s.type.name+" "+s.path]=!0),s.onCompleted&&s.onCompleted(null,t)))},this._removeWaitFree(s),(t=s.bundle.get(s.path,s.type.type))?e(null,t):s.bundle.load(s.path,s.type.type,s.onProgess,e))},e.prototype.free=function(){if(!this._isDestroyed){var e=this._makeArgsFree.apply(this,arguments);if(1<arguments.length)this._addWaitFree(e);else{var t=this._mapUses[e.keyUse];if(t)for(var s in t){s=s.split(" ");this._addWaitFree({keyUse:e.keyUse,bundle:cc.assetManager.getBundle(s[0]),type:mapNameAssetTypes[s[1]],path:s[2]})}}}},e.prototype._checkAndDoWaitFrees=function(){var e,t=this,s=this._waitFrees,n=this._time,i=[];for(e in s){var a=e.split(" ");s[e]<=n&&i.push({keyUse:a[0],bundle:cc.assetManager.getBundle(a[1]),type:mapNameAssetTypes[a[2]],path:a[3]})}i.forEach(function(e){delete s[e.keyUse+" "+e.bundle.name+" "+e.type.name+" "+e.path],t._doFree(e.keyUse,e.path,e.type,e.bundle)})},e.prototype._doFree=function(e,t,s,n){var i=this._mapUses,a=i[e];delete a[n.name+" "+s.name+" "+t],n.get(t,s.type).decRef(),Object.keys(a).length||delete i[e]},e.prototype._addWaitFree=function(e){this._waitFrees[e.keyUse+" "+e.bundle.name+" "+e.type.name+" "+e.path]=this._time+this._delayFree},e.prototype._removeWaitFree=function(e){delete this._waitFrees[e.keyUse+" "+e.bundle.name+" "+e.type.name+" "+e.path]},e.prototype._update=function(){++this._time,this._loadingCount<=0&&this._checkAndDoWaitFrees()},e.prototype._clear=function(){this._loadingCount=0;var e,t=this._mapUses;for(e in t){var s=t[e];if(s)for(var n in s){n=n.split(" ");cc.assetManager.getBundle(n[0]).get(n[2],mapNameAssetTypes[n[1]].type).decRef()}}this._mapUses={},this._waitFrees={},this._time=0},e.prototype._makeArgsUse=function(){if(arguments.length<3||"string"!=typeof arguments[0]||"string"!=typeof arguments[1])throw new Error("Arguments is invalid !");for(var e={keyUse:arguments[0].trim(),path:arguments[1].trim(),type:arguments[2],bundle:cc.resources},t=3;t<arguments.length;++t)3==t&&"function"!=typeof arguments[t]?e.bundle=arguments[t]||cc.resources:"function"==typeof arguments[t]&&(t+1<arguments.length&&"function"==typeof arguments[t+1]?e.onProgess=arguments[t]:e.onCompleted=arguments[t]);return e},e.prototype._makeArgsFree=function(){if(arguments.length<1||"string"!=typeof arguments[0])throw new Error("Arguments is invalid !");return{keyUse:arguments[0].trim(),path:"string"==typeof arguments[1]?arguments[1].trim():arguments[1],type:arguments[2],bundle:arguments[3]||cc.resources}},e}();exports.AssetsAgent=AssetsAgent,exports.assetsAgent=new AssetsAgent,window&&(window.assetsAgent=exports.assetsAgent);